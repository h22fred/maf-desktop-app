@* LICENSE
 *
 * Copyright (c) 2015, The Agile Factory SA and/or its affiliates. All rights
 * reserved.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 *@
@(
    portfolioEntry: models.pmo.PortfolioEntry,
    costToCompleteWorkOrderTable: framework.utils.Table[utils.table.WorkOrderListView],
    engagedWorkOrderTable: framework.utils.Table[utils.table.WorkOrderListView],
    lineItemTable: framework.utils.Table[utils.table.PurchaseOrderLineItemListView]
)
 
@import be.objectify.deadbolt.java.views.html._
@import be.objectify.deadbolt.core.utils.TemplateUtils._
@import framework_views.parts
@import framework_views.parts.formats._
@import views.html.modelsparts._
@import views.html.commons._

@breadcrump=@{
    Seq(
        (display_portfolio_entry(portfolioEntry, false).toString, controllers.core.routes.PortfolioEntryController.overview(portfolioEntry.id).url),
        ("core.portfolio_entry.sidebar.financial.label", null)
    )
}

@budgetTrackingLastRun=@{
    if(portfolioEntry.budgetTrackingLastRun != null) {
        framework.utils.Utilities.getDateFormat(framework.utils.Utilities.getDefaultDatePattern() + " HH:mm").format(portfolioEntry.budgetTrackingLastRun)
    } else {
        framework.commons.IFrameworkConstants.DEFAULT_VALUE_EMPTY_DATA
    }
}

@views.html.core.portfolioentry.portfolio_entry_template(portfolioEntry, controllers.core.PortfolioEntryController.MenuItemType.FINANCIAL, breadcrump){

    <span id="portfolio-entry-@(portfolioEntry.id)-financial-details"></span>
    
    <h4>@parts.Msg("core.portfolio_entry_financial.view.budget.title")</h4>


    <div class="panel panel-default">

        <div class="panel-heading">
            @parts.Msg("core.portfolio_entry_financial.view.budget.panel.budget.title")

            <div class="pull-right">
                @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                    @if(_budgetTrackingService.isActive()) {
                        <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                    }
                    &nbsp; <a href="@controllers.core.routes.PortfolioEntryFinancialController.manageBudgetLine(portfolioEntry.id).url" data-toggle="tooltip" title="@parts.Msg("tooltip.add")"><span class="fa fa-plus fa-lg"></span></a>

                }
            </div>
        </div>

        <div class="panel-body">
            <div class="row">
                <div id="budget-line-table-filters" class="col-md-7">
                    <a id="budgetLineTable_filterContainerCollapse" data-toggle="button" href="#"><i class="fa fa-minus-circle"></i>&nbsp;<small>@parts.Msg("filter.togglebutton.label")</small></a>
                    <ul id="budgetLineTable_filterContainer" class="list-inline">
                    </ul>
                </div>
                <div class="col-md-5">

                    <div class="row">

                        <div class="col-md-6 text-right" id="budgetLineTable_filterConfiguration">
                        </div>

                        <div class="col-md-4 text-right" id="budgetLineTable_currentFilterConfiguration">
                            <a href="#" class="btn btn-primary" id="budgetLineTable_columnsSelector"><i class="fa fa-cog"></i></a>
                        </div>

                        <div class="col-md-2 text-right">
                            <a href="#" class="btn btn-primary" id="budgetLineTable_exportAsExcel"><i class="fa fa-download"></i></a>
                        </div>

                    </div>
            </div>
            <table id="budgetLineTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.ref_id.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.name.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.expenditure_type.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.currency.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.amount.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.budget_bucket.label")</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    
    <h4>@parts.Msg("core.portfolio_entry_financial.view.forecast.title")</h4>
    @if(_budgetTrackingService.isActive() && portfolioEntry.budgetTrackingHasUnallocatedTimesheet) {
        <div class="alert alert-warning">
            @parts.Msg("core.portfolio_entry_financial.budget_tracking.unallocated_timesgeet.help")
        </div>
    }
    
    <div class="panel panel-default">
    
        <div class="panel-heading">
            @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.cost_to_complete.title")
            
            <div class="pull-right">
                @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                    @if(_budgetTrackingService.isActive()) {
                        <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                    }
                    &nbsp; <a href="@controllers.core.routes.PortfolioEntryFinancialController.manageWorkOrder(portfolioEntry.id).url" data-toggle="tooltip" title="@parts.Msg("tooltip.add")"><span class="fa fa-plus fa-lg"></span></a>
                }
            </div>
        </div>

        <div class="panel-body">
            @parts.table.tableview(costToCompleteWorkOrderTable)
        </div>
        
    </div>


    @if(engagedWorkOrderTable.hasValues) {
        <div class="panel panel-default">
        
            <div class="panel-heading">
                @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.engaged_work_order.title")
                
                <div class="pull-right">
                    @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                        @if(_budgetTrackingService.isActive()) {
                            <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                        }
                    }
                </div>
                
            </div>

            <div class="panel-body">
                @parts.table.tableview(engagedWorkOrderTable)
            </div>
            
        </div>
    }

    @if(dao.finance.PurchaseOrderDAO.isSystemPreferenceUsePurchaseOrder(_preferenceManagerPlugin) && lineItemTable.hasValues) {
        <div class="panel panel-default">
    
            <div class="panel-heading">
                @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.engaged_purchase_order.title")
            </div>

            <div class="panel-body">
                @parts.table.tableview(lineItemTable)
            </div>
        
        </div>
    }
    
    <script>
        $('.run-budget-tracking-link').tooltip();

        $(document).ready(function () {
            var budgetLineTableElement = $('#budgetLineTable');
            var filterContainerElement = $('#budgetLineTable_filterContainer');
            var filterContainerCollapseElement = $('#budgetLineTable_filterContainerCollapse');

            var budgetLineTable = budgetLineTableElement.DataTable({
                ajax: {
                    url: '@controllers.api.table.routes.PortfolioEntryTableController.getPortfolioEntryBudgetLineListView(portfolioEntry.id).url',
                    dataSrc: ''
                },
                deferRender: true,
                stateSave: true,
                columns: [
                    { data: 'refId' },
                    { data: 'name' },
                    { data: 'expenditureType' },
                    { data: 'currency' },
                    { data: 'amount', render: { _: 'amount', display: 'display' } },
                    { data: 'budgetBucket', render: { _: 'text', display: 'display' } }
                ]
            });

            budgetLineTableElement.find('tbody').on('click', 'tr', function() {
                window.location.href = budgetLineTable.row(this).data()['link'];
            });

            budgetLineTableElement.find('thead th').each(function(index) {
                var title = $(this).text();
                var filterId = 'budgetLineTable_filterContainer_'+index;

                filterContainerElement.append('<li class="filter-input"><div><strong>'+title+'</strong></div><input id="'+filterId+'" class="form-control input-sm" type="text" />');

                $('#'+filterId).on('keyup change', function() {
                    var column = budgetLineTable.column(index);
                    if (column.search() !== this.value){
                        column.search(this.value).draw();
                    }
                })
            });

            filterContainerCollapseElement.click(function(){
                filterContainerCollapseElement.find('i').toggleClass('fa-minus-circle').toggleClass('fa-plus-circle');
                if(filterContainerCollapseElement.find('i').hasClass('fa-minus-circle')){
                    filterContainerElement.show();
                }else{
                    filterContainerElement.hide();
                }
            });
        })

    </script>


}