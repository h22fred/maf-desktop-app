@* LICENSE
 *
 * Copyright (c) 2015, The Agile Factory SA and/or its affiliates. All rights
 * reserved.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 *@
@(
    portfolioEntry: models.pmo.PortfolioEntry,
    costToCompleteWorkOrderTable: framework.utils.Table[utils.table.WorkOrderListView],
    engagedWorkOrderTable: framework.utils.Table[utils.table.WorkOrderListView],
    lineItemTable: framework.utils.Table[utils.table.PurchaseOrderLineItemListView]
)
 
@import be.objectify.deadbolt.java.views.html._
@import be.objectify.deadbolt.core.utils.TemplateUtils._
@import framework_views.parts
@import framework_views.parts.formats._
@import views.html.modelsparts._
@import views.html.commons._

@breadcrump=@{
    Seq(
        (display_portfolio_entry(portfolioEntry, false).toString, controllers.core.routes.PortfolioEntryController.overview(portfolioEntry.id).url),
        ("core.portfolio_entry.sidebar.financial.label", null)
    )
}

@budgetTrackingLastRun=@{
    if(portfolioEntry.budgetTrackingLastRun != null) {
        framework.utils.Utilities.getDateFormat(framework.utils.Utilities.getDefaultDatePattern() + " HH:mm").format(portfolioEntry.budgetTrackingLastRun)
    } else {
        framework.commons.IFrameworkConstants.DEFAULT_VALUE_EMPTY_DATA
    }
}

@views.html.core.portfolioentry.portfolio_entry_template(portfolioEntry, controllers.core.PortfolioEntryController.MenuItemType.FINANCIAL, breadcrump){

    <span id="portfolio-entry-@(portfolioEntry.id)-financial-details"></span>
    
    <h4>@parts.Msg("core.portfolio_entry_financial.view.budget.title")</h4>

    <div class="panel panel-default">
    
        <div class="panel-heading">
            @parts.Msg("core.portfolio_entry_financial.view.budget.panel.budget.title")
            
            <div class="pull-right">
                @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                    @if(_budgetTrackingService.isActive()) {
                        <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                    }
                    &nbsp; <a href="@controllers.core.routes.PortfolioEntryFinancialController.manageBudgetLine(portfolioEntry.id).url" data-toggle="tooltip" title="@parts.Msg("tooltip.add")"><span class="fa fa-plus fa-lg"></span></a>

                }
            </div>
        </div>

        <div class="panel-body">
            <table id="budgetLineTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.ref_id.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.name.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.expenditure_type.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.currency.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.amount.label")</th>
                        <th>@parts.Msg("object.portfolio_entry_budget_line.budget_bucket.label")</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    
    <h4>@parts.Msg("core.portfolio_entry_financial.view.forecast.title")</h4>
    @if(_budgetTrackingService.isActive() && portfolioEntry.budgetTrackingHasUnallocatedTimesheet) {
        <div class="alert alert-warning">
            @parts.Msg("core.portfolio_entry_financial.budget_tracking.unallocated_timesgeet.help")
        </div>
    }
    
    <div class="panel panel-default">
    
        <div class="panel-heading">
            @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.cost_to_complete.title")
            
            <div class="pull-right">
                @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                    @if(_budgetTrackingService.isActive()) {
                        <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                    }
                    &nbsp; <a href="@controllers.core.routes.PortfolioEntryFinancialController.manageWorkOrder(portfolioEntry.id).url" data-toggle="tooltip" title="@parts.Msg("tooltip.add")"><span class="fa fa-plus fa-lg"></span></a>
                }
            </div>
        </div>

        <div class="panel-body">
            @parts.table.tableview(costToCompleteWorkOrderTable)
        </div>
        
    </div>


    @if(engagedWorkOrderTable.hasValues) {
        <div class="panel panel-default">
        
            <div class="panel-heading">
                @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.engaged_work_order.title")
                
                <div class="pull-right">
                    @dynamic(constants.IMafConstants.PORTFOLIO_ENTRY_FINANCIAL_EDIT_DYNAMIC_PERMISSION) {
                        @if(_budgetTrackingService.isActive()) {
                            <a class="run-budget-tracking-link" title="@parts.Msg("core.portfolio_entry_financial.budget_tracking.run.help", budgetTrackingLastRun)" data-toggle="tooltip" href="@controllers.core.routes.PortfolioEntryFinancialController.budgetTrackingRun(portfolioEntry.id).url"><span class="fa fa-refresh fa-lg"></span></a>
                        }
                    }
                </div>
                
            </div>

            <div class="panel-body">
                @parts.table.tableview(engagedWorkOrderTable)
            </div>
            
        </div>
    }

    @if(dao.finance.PurchaseOrderDAO.isSystemPreferenceUsePurchaseOrder(_preferenceManagerPlugin) && lineItemTable.hasValues) {
        <div class="panel panel-default">
    
            <div class="panel-heading">
                @parts.Msg("core.portfolio_entry_financial.view.forecast.panel.engaged_purchase_order.title")
            </div>

            <div class="panel-body">
                @parts.table.tableview(lineItemTable)
            </div>
        
        </div>
    }
    
    <script>
        $('.run-budget-tracking-link').tooltip();

        $(document).ready(function () {
            var budgetLineTableElement = $('#budgetLineTable');
            var budgetLineTable = budgetLineTableElement.DataTable({
                ajax: {
                    url: '@controllers.api.table.routes.PortfolioEntryTableController.getPortfolioEntryBudgetLineListView(portfolioEntry.id).url',
                    dataSrc: ''
                },
                deferRender: true,
                searchable: false,
                columns: [
                    { data: 'refId' },
                    { data: 'name' },
                    { data: 'expenditureType' },
                    { data: 'currency' },
                    { data: 'amount', render: { _: 'amount', display: 'display' } },
                    { data: 'budgetBucket', render: { _: 'text', display: 'display' } }
                ],
                columnDefs: [
                    { targets: '_all', searchable: true }
                ]
            });

            yadcf.init(budgetLineTable, [
                { column_number: 0, filter_type: 'text' },
                { column_number: 1, filter_type: 'text' },
                { column_number: 2, filter_type: 'multi_select' },
                { column_number: 3, filter_type: 'multi_select' },
                { column_number: 4, filter_type: 'range_number_slider' },
                { column_number: 5, filter_type: 'text' }
            ]);

            budgetLineTableElement.find('tbody').on('click', 'tr', function() {
                window.location.href = budgetLineTable.row(this).data()['link'];
            });
        })

    </script>


}